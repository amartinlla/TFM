{{extend 'layout.html'}}
{{pass}}

<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/dt/jqc-1.12.4/jszip-2.5.0/pdfmake-0.1.18/dt-1.10.13/b-1.2.4/b-colvis-1.2.4/b-flash-1.2.4/b-html5-1.2.4/b-print-1.2.4/cr-1.3.2/fc-3.2.2/fh-3.1.2/rr-1.2.0/se-1.2.0/datatables.min.css">
<script src="https://cdn.datatables.net/v/dt/jqc-1.12.4/jszip-2.5.0/pdfmake-0.1.18/dt-1.10.13/b-1.2.4/b-colvis-1.2.4/b-flash-1.2.4/b-html5-1.2.4/b-print-1.2.4/cr-1.3.2/fc-3.2.2/fh-3.1.2/rr-1.2.0/se-1.2.0/datatables.min.js"></script>
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.16/css/jquery.dataTables.min.css">


<style>
    
.dt-button.red {
    color: red;
    }
.dt-button.green {
    color: green;
    }
.dt-button.orange {
    color: orange;
    }
.dt-button.blue {
    color: blue;
    }  
.dt-button.BlueViolet {
    color: BlueViolet;
    } 
     
th.table-cell-edit{
    background-color: #99ccff;
}
.dt-buttons{
float:right;
 margin-left:5px;
 margin-bottom:7px;
 }
.dataTables_wrapper{
margin-top:
</style>
<style>
/* Styles for the drop-down. Feel free to change the styles to suit your website. :-) */
.cb-dropdown-wrap {
  max-height: 80px; /* At most, around 3/4 visible items. */
  position: relative;
  height: 19px;
}
.cb-dropdown,
.cb-dropdown li {
  margin: 0;
  padding: 0;
  list-style: none;
}
.cb-dropdown {
  position: absolute;
  z-index: 1;
  width: 100%;
  height: 100%;
  overflow: hidden;
  background: #fff;
  border: 1px solid #888;
}
/* For selected filter. */
.active .cb-dropdown {
  background: #fff;
}
.cb-dropdown-wrap:hover .cb-dropdown {
  height: 80px;
  overflow: auto;
  transition: 0.2s height ease-in-out;
}
/* For selected items. */
.cb-dropdown li.active {
  background: #cce0ff;
}
.cb-dropdown li label {
  display: block;
  position: relative;
  cursor: pointer;
  line-height: 19px; /* Match height of .cb-dropdown-wrap */
}
.cb-dropdown li label > input {
  position: absolute;
  right: 0;
  top: 0;
  width: 16px;
}
.cb-dropdown li label > span {
  display: block;
  margin-left: 3px;
  margin-right: 20px; /* At least, width of the checkbox. */
  font-family: sans-serif;
  font-size: 0.8em;
  font-weight: normal;
  text-align: left;
}
/* This fixes the vertical aligning of the sorting icon. */
table.dataTable thead .sorting,
table.dataTable thead .sorting_asc,
table.dataTable thead .sorting_desc,
table.dataTable thead .sorting_asc_disabled,
table.dataTable thead .sorting_desc_disabled {
  background-position: 100% 10px;
}
</style>

<h1>VCFWeb</h1>
<br></br>

<h2>Variant Information for filtering and priorizing</h2>
<br></br>

<div class="topnav">
  <button type="button" class="bn btn-primary" onclick="location.href='{{=URL('user/login')}}'">Go HOME</button>
  <button type="button" class="bn btn-primary" onclick="location.href='{{=URL('variants')}}'">VARIANTS</button>
</div>
<br></br>
<table id="all-table" class="display" cellspacing="0" width="100%">
        <thead>
            <tr>
                <th class=table-cell-edit>CHROM</th>
                <th class=table-cell-edit>POS</th>
                <th class=table-cell-edit>CONSEQUENCE</th>
                <th class=table-cell-edit>IMPACT</th>
                <th class=table-cell-edit>CLINVAR</th>
                <th class=table-cell-edit>MAX_FREQ</th>
                <th class=table-cell-edit>EXISTING_VAR</th>
                <th class=table-cell-edit>SYMBOL</th>
                <th class=table-cell-edit>GENE</th>
                <th class=table-cell-edit>FEATURE_TYPE</th>
                <th class=table-cell-edit>FEATURE</th>
                <th class=table-cell-edit>BIOTYPE</th>
                <th class=table-cell-edit>SIFT</th>
                <th class=table-cell-edit>POLYPHEN</th>
                <th class=table-cell-edit>LOFTOOL</th>
                <th class=table-cell-edit>CADD_PHRED</th>                
                <th class=table-cell-edit>AF</th>
                <th class=table-cell-edit>AFR_AF</th>
                <th class=table-cell-edit>AMR_AF</th>
                <th class=table-cell-edit>ASJ_AF</th>
                <th class=table-cell-edit>EAS_AF</th>
                <th class=table-cell-edit>FIN_AF</th>
                <th class=table-cell-edit>NFE_AF</th>
                <th class=table-cell-edit>OTH_AF</th>
                <th class=table-cell-edit>SAS_AF</th>
                <th class=table-cell-edit>GENOTYPE</th>
            </tr>
        </thead>
        <tfoot>
            <tr>
                <th><input type="button" class="column_filter">CHROM</th>
                <th>POS</th>
                <th>CONSEQUENCE</th>
                <th>IMPACT</th>
                <th>CLINVAR</th>
                <th>MAX_FREQ</th>
                <th>EXISTING_VAR</th>
                <th>SYMBOL</th>
                <th>GENE</th>
                <th>FEATURE_TYPE</th>
                <th>FEATURE</th>
                <th>BIOTYPE</th>
                <th>SIFT</th>
                <th>POLYPHEN</th>
                <th>LOFTOOL</th>
                <th>CADD_PHRED</th>                
                <th>AF</th>
                <th>AFR_AF</th>
                <th>AMR_AF</th>
                <th>ASJ_AF</th>
                <th>EAS_AF</th>
                <th>FIN_AF</th>
                <th>NFE_AF</th>
                <th>OTH_AF</th>
                <th>SAS_AF</th>
                <th>GENOTYPE</th>
            </tr>
        </tfoot>
</table>

<br></br>

<h3>
    Filter by position initial and final
</h3>
<br>
<table cellspacing="5" cellpadding="5" border="0">
    <tbody>
        <tr>
            <td>Initial Pos:</td>
            <td><input id="min" name="min" type="text"></td>
            <td>Final Pos:</td>
            <td><input id="max" name="max" type="text"></td>
        </tr>
    </tbody>
</table>

<h3>
    Select MAX_FREQ Threshold
</h3>
<br>
<table cellspacing="5" cellpadding="5" border="0">
    <tbody>
        <tr>
            <td>Maximum Threshold:</td>
            <td><input id="thres" name="thres" type="text"></td>
        </tr>
    </tbody>
</table>


<script>
  /* Custom filtering function which will search data in column four between two values */
//Filter for POS
$.fn.dataTable.ext.search.push(
    function( settings, data, dataIndex ) {
        var min = parseInt( $('#min').val(), 10 );
        var max = parseInt( $('#max').val(), 10 );
        var pos = parseFloat( data[1] ) || 0; // use data for the pos column
 
        if ( ( isNaN( min ) && isNaN( max ) ) ||
             ( isNaN( min ) && pos <= max ) ||
             ( min <= pos   && isNaN( max ) ) ||
             ( min <= pos   && pos <= max ) )
        {
            return true;
        }
        return false;
    }
);
//Filter for MAX_FREQ
$.fn.dataTable.ext.search.push(
    function( settings, data, dataIndex ) {
        var thres = parseFloat( $('#thres').val(), 10 );
        var value = parseFloat( data[5] ) || 0; // use data for the pos column
 
        if ( ( isNaN( thres ) ) ||
             ( value <= thres ) )
        {
            return true;
        }
        return false;
    }
);
  $(document).ready(function() {
    function cbDropdown(column) {
		return $('<ul>', {
		  'class': 'cb-dropdown'
		}).appendTo($('<div>', {
		  'class': 'cb-dropdown-wrap'
		}).appendTo(column));
  	}
    var table= $('#all-table').DataTable( {
       data:  {{=results}},
       columns: [
            { data: 'chrom' },
            { data: 'pos' },
            { data: 'consequence' },
            { data: 'impact' },
            { data: 'clin_sig'},
            { data: 'max_af' },                                         
            {
                data: 'name',
                "render": function(data, type, full, meta) {
                    return '<a href="https://www.ensembl.org/Homo_sapiens/Variation/Explore?v=' + data + '" target="_blank">' + data + '</a>';
                }
            },
            //{ data: 'name' },
            { data: 'symbol' },
            {
                data: 'gene',
                "render": function(data, type, full, meta) {
                    return '<a href="https://www.ensembl.org/Homo_sapiens/Gene/Summary?g=' + data + '" target="_blank">' + data + '</a>';
                }
            },
            //{ data: 'gene' },
            { data: 'feature_type' },
            {
                data: 'feature',
                "render": function(data, type, full, meta) {
                    return '<a href="https://www.ensembl.org/Homo_sapiens/Transcript/Summary?t=' + data + '" target="_blank">' + data + '</a>';
                }
            },
            //{ data: 'feature' },
            { data: 'biotype' },
            { data: 'sift' },
            { data: 'polyphen' },
            { data: 'loftool' },
            { data: 'cadd_phred' },
            { data: 'af' },
            { data: 'afr_af' },
            { data: 'amr_af' },
            { data: 'asj_af' },
            { data: 'eas_af' },
            { data: 'fin_af' },
            { data: 'nfe_af' },
            { data: 'oth_af' },
            { data: 'sas_af' },
            { data: 'alleles'},
        ],
        fixedHeader: {
						   header: true,
					},
	   colReorder: true,
	   fixedColumns:   {
			   leftColumns: 0
						},
	   rowReorder: true,
	   dom: 'Bfrtip',
	   lengthMenu:[
				 [10,25,50,-1],
				 ['10 rows', '25 rows', '50 rows', 'Show all']
		],
		buttons: [
           {
            extend:'pageLength',
            text: '<i class="fa fa-list-ol" aria-hidden="true" style="color:darkblue">Page Length</i>',
            titleAttr: 'show no.of rows'
            },
    		{
				extend: 'colvis',
				text: '<i class="fa fa-columns" aria-hidden="true" style="color:darkblue">Fields to show</i>',
				titleAttr: 'Column Visibility',
				exportOptions: {
					columns: ':visible',
				}
            },
		  	{
                extend: 'collection',
                className: 'bn bt-primary',
                text: 'Export',
                buttons: [
                    {
                        extend: 'copyHtml5',
                        text: 'Copy',
                        className: 'blue'
                    },
                    {
                        extend: 'excelHtml5',
                        text: 'Excel',
                        className: 'green'
                    },
                    {
                        extend: 'csvHtml5',
                        text: 'CSV',
                        className: 'orange'
                    },
                    {
                        extend: 'pdfHtml5',
                        text: 'PDF',
                        className: 'red'
                    },
                    {
                        extend: 'print',
                        text: 'Print',
                        className: 'BlueViolet'
                    }
                ]
            },
        ],
		//scrollY:        true,
		deferRender:    true,
		scroller:       true,
		//scrollX:        true,
	  	scrollCollapse: true,
       	select:true,
	    initComplete: function() {
		  this.api().columns([0,2,3,4,8,10,15]).every(function() {
			var column = this;
			var ddmenu = cbDropdown($(column.footer()).empty() )
			  .on('change', ':checkbox', function() {
				var active;
				var vals = $(':checked', ddmenu).map(function(index, element) {
				  active = true;
				  return $.fn.dataTable.util.escapeRegex($(element).val());
				}).toArray().join('|');
				column
				  .search(vals.length > 0 ? '^(' + vals + ')$' : '', true, false)
				  .draw();
				// Highlight the current item if selected.
				if (this.checked) {
				  $(this).closest('li').addClass('active');
				} else {
				  $(this).closest('li').removeClass('active');
				}
				// Highlight the current filter if selected.
				var active2 = ddmenu.parent().is('.active');
				if (active && !active2) {
				  ddmenu.parent().addClass('active');
				} else if (!active && active2) {
				  ddmenu.parent().removeClass('active');
				}
			  });
			column.data().unique().sort().each(function(d, j) {
			  var // wrapped
				$label = $('<label>'),
				$text = $('<span>', {
				  text: d
				}),
				$cb = $('<input>', {
				  type: 'checkbox',
				  value: d
				});
			  $text.appendTo($label);
			  $cb.appendTo($label);
			  ddmenu.append($('<li>').append($label));
			});
		  });
    }
       } );
       $('#min, #max').keyup( function() {
        table.draw();
        } );
        $('#thres').keyup( function() {
        table.draw();
        } );
         // Setup - add a text input to each footer cell
    $('#all-table tfoot th').each( function (i) {
        if (i==6  || i==7 || i==9 || i==11 || i==12 || i==13 || i==14 || i==15 || i==16 || i==17 || i==18 || i==19 || i==20 || i==21 || i==22 || i==23 || i==24 || i==25){
            var title = $('#all-table thead th').eq( $(this).index() ).text();
            $(this).html( '<input type="text" placeholder="Search '+title+'" data-index="'+i+'" />' );
        }
    } );
    // Filter event handler
    $( table.table().container() ).on( 'keyup', 'tfoot input', function () {
        table
            .column( $(this).data('index') )
            .search( this.value )
            .draw();
    } );
} );
</script>
